<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Cortex-M Architecture | Mehmet Bozdal</title> <meta name="author" content="Mehmet Bozdal"> <meta name="description" content="The ArmCortex-M3 microcontroller architecture follows the Harvard architecture design, separating memory into distinct areas for instructions and data."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://mbozdal.github.io/blog/2023/cortex-m_architecture/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Mehmet </span>Bozdal</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">Teaching</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Cortex-M Architecture</h1> <p class="post-meta">August 9, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/embedded"> <i class="fas fa-hashtag fa-sm"></i> embedded</a>   </p> </header> <article class="post-content"> <p>The ArmCortex-M3 microcontroller architecture follows the Harvard architecture design, separating memory into distinct areas for instructions and data. This allows for simultaneous access to both instruction memory and data memory, leading to improved performance.</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/system_architecture_stm32.JPG-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/system_architecture_stm32.JPG-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/system_architecture_stm32.JPG-1400.webp"></source> <img src="/assets/img/system_architecture_stm32.JPG" width="auto" height="auto" title="System architecture of STM32F1x Series" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The Cortex-M instruction set includes the “Thumb” instruction set, which is a 16-bit compact encoding of instructions. This allows for more instructions to fit into a smaller memory space. Thumb-2 further extends this concept, allowing a mix of 16-bit and 32-bit instructions for better code density and performance.</p> <p>The Cortex-M3 microcontroller architecture employs distinct buses and features for different tasks, contributing to its efficient operation in embedded systems:</p> <ol> <li> <strong>ICode Bus</strong>: This bus is responsible for fetching instructions from memory, typically from a flash ROM. This is the pathway through which the processor retrieves program code for execution.</li> <li> <strong>DCode Bus</strong>: The DCode bus is used for debugging purposes. It provides a pathway for advanced debugging features, allowing developers to interact with and analyze the behavior of the microcontroller during program execution.</li> <li> <strong>System Bus Interface</strong>: The system bus interface facilitates data exchange between the processor core and memory, as well as input/output (I/O) devices. It’s a critical bus for moving data around in the system.</li> <li> <strong>DMA (Direct Memory Access)</strong>: DMA is a mechanism that allows certain peripherals to directly access memory without involving the processor core. This enhances data transfer efficiency and offloads the CPU from managing data movement.</li> <li> <strong>AHB (Advanced High-performance Bus)</strong>: AHB is a high-performance bus protocol used to connect faster components in the system, like memory blocks, high-speed I/O (USB, Ethernet), and so on. It’s designed to handle higher bandwidth and provide better performance.</li> <li> <strong>APB (Advanced Peripheral Bus)</strong>: APB is a slower peripheral bus protocol used to connect slower peripherals in the system. It’s used for components that don’t require high-speed access and is more power-efficient.</li> </ol> <h2 id="registers">Registers</h2> <p>Registers are small fast storage areas within the CPU that are used to hold data temporarily during program execution. They are integral to various aspects of the processor’s functioning, such as data manipulation, control flow, and interaction with memory and peripherals.</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/core_registers.JPG-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/core_registers.JPG-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/core_registers.JPG-1400.webp"></source> <img src="/assets/img/core_registers.JPG" width="auto" height="auto" title="Core Registers" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The Core registers found in Arm microcontrollers are:</p> <ol> <li> <strong>General-Purpose Registers (GPRs)</strong>: R0-R12 are 32-bit general-purpose registers for data operations. These registers are used for general data manipulation. They store operands for arithmetic and logical operations, intermediate results, and function parameters.</li> <li> <strong>Stack Pointer (SP)</strong>: The SP (R13) register points to the top of the stack in memory. The stack is used to store temporary data during function calls, interrupt handling, and other operations. In Thread mode, bit[1] of the CONTROL register indicates the stack pointer to use: <ul> <li>0 = <em>Main Stack Pointer</em> (MSP). This is the reset value.</li> <li>1 = <em>Process Stack Pointer</em> (PSP).</li> </ul> <p>On reset, the processor loads the MSP with the value from address <code class="language-plaintext highlighter-rouge">0x00000000</code>.</p> </li> <li> <strong>Link Register (LR)</strong>: The LR (R14) register holds the return address for subroutines, function calls, and exceptions. It’s used to ensure that the program knows where to resume execution after the function call is complete. On reset, the processor sets the LR value to <code class="language-plaintext highlighter-rouge">0xFFFFFFFF.</code> </li> <li> <strong>Program Counter (PC)</strong>: The PC (R15) register holds the address of the next instruction to be fetched and executed. It keeps track of the program’s execution progress. On reset, the processor loads the PC with the value of the reset vector, which is at address <code class="language-plaintext highlighter-rouge">0x00000004</code>. Bit[0] of the value is loaded into the EPSR T-bit at reset and must be 1.</li> <li> <strong>Program Status Registers (PSR)</strong>: The <em>Program Status Register</em> (PSR) combines: <ul> <li> <em>Application Program Status Register</em> (APSR)</li> <li> <em>Interrupt Program Status Register</em> (IPSR)</li> <li> <em>Execution Program Status Register</em> (EPSR).</li> </ul> <p>These registers hold various flags and status information about the processor’s state. For example, they store the condition codes after arithmetic operations and control the processor’s execution mode.</p> <p>These registers are mutually exclusive bitfields in the 32-bit PSR. The bit assignments are:</p> </li> </ol> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/program_status_register.JPG-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/program_status_register.JPG-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/program_status_register.JPG-1400.webp"></source> <img src="/assets/img/program_status_register.JPG" width="auto" height="auto" title="Program Status Registers" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The key components stored in the APSR:</p> <ol> <li> <strong>Negative Flag (N) - Bit [31]</strong>: This flag is set if the result of a signed operation is negative.</li> <li> <strong>Zero Flag (Z) - Bit [30]</strong>: This flag is set if the result of an operation is zero. It’s used in conditional branching and testing.</li> <li> <strong>Carry or Unsigned Overflow Flag (C) - Bit [29]</strong>: This flag is set if an operation generates a carry out from the most significant bit or an unsigned overflow condition.</li> <li> <strong>Overflow Flag (V) - Bit [28]</strong>: This flag is set if a signed operation results in an overflow condition.</li> <li> <strong>Q Flag - Bit [27]</strong>: It’s used in the context of saturation arithmetic (like Saturating Addition and Saturating Subtraction instructions).</li> <li> <strong>Exception Mask Registers:</strong> The exception mask registers disable the handling of exceptions by the processor. Disable exceptions where they might impact on timing critical tasks. <ol> <li> <strong>Priority Mask Register (PRIMASK):</strong> The PRIMASK register prevents activation of all exceptions with configurable priority. Bit [0] of this register controls the activation of exceptions. Its behavior is as follows: <ul> <li>1 = prevents the activation of all exceptions with configurable priority.</li> <li>0 = no effect</li> </ul> </li> <li> <strong>Fault Mask Register (FAULTMASK):</strong> The FAULTMASK register prevents activation of all exceptions except for <em>Non-Maskable Interrupt</em> (NMI). <ul> <li>1 = prevents the activation of all exceptions except for NMI.</li> <li>0 = no effect</li> </ul> </li> <li> <strong>Base Priority Mask Register (BASEPRI):</strong> It is a special register used to control the priority level at which interrupts can preempt the currently executing code. It provides a mechanism for setting a “base” priority level below which certain interrupts will not preempt the execution of code at higher priority levels. Bit [7:0] of this register controls the behavior as follow: <ul> <li>0x 00 = no effect</li> <li>Nonzero = defines the base priority for exception processing. The processor does not process any exception with a priority value greater than or equal to BASEPRI.</li> </ul> <p>Suppose we set BASEPRI to a value of 3. This means that interrupts with priority levels 0, 1, and 2 can still interrupt the ongoing task. However, requests at priority levels 3 and higher will be held off temporarily. In other words, only the most important interrupts below the threshold will be allowed to break into the execution of the current task.</p> </li> </ol> </li> <li> <strong>CONTROL Register</strong>: The CONTROL register controls the stack used and the privilege level for software execution when the processor is in Thread mode. The CONTROL register bit **assignments are:</li> </ol> <table> <thead> <tr> <th>Bits</th> <th>Name</th> <th>Function</th> </tr> </thead> <tbody> <tr> <td>[31:2]</td> <td>-</td> <td>Reserved.</td> </tr> <tr> <td>[1]</td> <td>SPSEL</td> <td>Defines the currently active stack pointer: In Handler mode this bit reads as zero and ignores writes. The Cortex-M3 updates this bit automatically on exception return. <strong>0</strong> = MSP is the current stack pointer <strong>1</strong> = PSP is the current stack pointer.</td> </tr> <tr> <td>[0]</td> <td>nPRIV</td> <td>Defines the Thread mode privilege level: <strong>0</strong> = Privileged <strong>1</strong> = Unprivileged.</td> </tr> </tbody> </table> <p><strong>Additional Resources:</strong></p> <p><a href="https://developer.arm.com/documentation/dui0552/a/the-cortex-m3-processor/programmers-model/core-registers?lang=en" rel="external nofollow noopener" target="_blank">Cortex-M3 Devices Generic User Guide</a></p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Mehmet Bozdal. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>